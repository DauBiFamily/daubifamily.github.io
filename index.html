<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng √în T·∫≠p ƒê·∫≠u B√≠ Family</title>
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --p-navy: #5D6D7E; --p-rose: #D98880; --p-teal: #76D7C4; --p-sun: #F7DC6F; --p-purple: #AF7AC5; }
        body { font-family: 'Quicksand', sans-serif; background: #f4f4f4 url('https://img.freepik.com/free-vector/hand-drawn-back-school-background_23-2149464866.jpg') fixed; background-size: cover; background-blend-mode: multiply; margin: 0; }
        header { background: linear-gradient(135deg, var(--p-navy), var(--p-purple)); color: white; padding: 40px 20px; text-align: center; border-bottom: 8px solid var(--p-sun); }
        .tabs-container { max-width: 1000px; margin: 20px auto; padding: 0 20px; }
        .grade-tabs, .subject-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab-btn { padding: 12px 25px; border-radius: 30px; cursor: pointer; font-weight: 700; background: white; border: 2px solid var(--p-navy); }
        .tab-btn.active { background: var(--p-navy); color: white; }
        .subject-btn { padding: 8px 18px; border-radius: 10px; background: var(--p-rose); color: white; border: none; cursor: pointer; opacity: 0.6; }
        .subject-btn.active { opacity: 1; transform: scale(1.1); font-weight: bold; }
        
        .quiz-section { background: rgba(255, 255, 255, 0.95); max-width: 900px; margin: 0 auto 50px; padding: 30px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); }
        .test-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px dashed #ccc; padding-bottom: 15px; margin-bottom: 25px; }
        
        /* Tinh ch·ªânh h√¨nh ·∫£nh nh·ªè l·∫°i v·ª´a ƒë·ªß */
        .q-img { max-width: 250px; height: auto; border-radius: 10px; margin: 10px 0; display: block; border: 2px solid #eee; }
        
        .question-card { background: #fdfdfd; border-left: 5px solid var(--p-purple); padding: 20px; margin-bottom: 25px; border-radius: 10px; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .option-item { padding: 10px; background: #eee; border-radius: 8px; cursor: pointer; display: flex; align-items: center; border: 2px solid transparent; }
        .option-item:hover { background: #e0e0e0; }
        .option-item.locked { pointer-events: none; opacity: 0.8; } /* Kh√≥a khi ƒë√£ n·ªôp b√†i */
        
        .explanation { margin-top: 15px; padding: 10px; border-radius: 5px; display: none; font-style: italic; font-weight: bold;}
        
        .btn-group { display: flex; gap: 10px; }
        .btn-submit { flex: 2; padding: 20px; background: var(--p-teal); color: white; font-size: 1.2rem; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; }
        .btn-retry { flex: 1; padding: 20px; background: var(--p-navy); color: white; font-size: 1.2rem; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; display: none; }
        
        /* B·∫£ng l·ªãch s·ª≠ h·ªçc t·∫≠p */
        .history-section { margin-top: 30px; border-top: 2px solid #eee; padding-top: 20px; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; background: white; border-radius: 10px; overflow: hidden; }
        .history-table th, .history-table td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        .history-table th { background-color: var(--p-navy); color: white; }
        .history-table tr:nth-child(even) { background-color: #f9f9f9; }

        .score-display { font-size: 2rem; text-align: center; display: none; margin-bottom: 20px; color: var(--p-purple); font-weight: bold; }
    </style>
</head>
<body>

<header>
    <h1>C·ªïng H·ªçc T·∫≠p Ti·ªÉu H·ªçc ƒê·∫≠u B√≠ Family</h1>
    <p>H·ªçc chƒÉm ch·ªâ - Thi t·ª± tin - ƒêi·ªÉm 10 x·ª©ng ƒë√°ng</p>
</header>

<div class="tabs-container">
    <div class="grade-tabs">
        <button class="tab-btn" onclick="changeGrade(1)">L·ªõp 1</button>
        <button class="tab-btn active" onclick="changeGrade(2)">L·ªõp 2</button>
        <button class="tab-btn" onclick="changeGrade(3)">L·ªõp 3</button>
        <button class="tab-btn" onclick="changeGrade(4)">L·ªõp 4</button>
        <button class="tab-btn" onclick="changeGrade(5)">L·ªõp 5</button>
    </div>
    <div id="subject-tabs" class="subject-tabs"></div>

    <div class="quiz-section">
        <div class="test-header">
            <h2 id="current-info">Vui l√≤ng ch·ªçn ƒë·ªÅ</h2>
            <select id="test-select" onchange="loadTestFile()" style="padding: 10px; border-radius: 5px;">
                <option value="">-- Ch·ªçn ƒë·ªÅ --</option>
                <script>
                    for(let i=1; i<=20; i++) document.write(`<option value="${i}">ƒê·ªÅ s·ªë ${i}</option>`);
                </script>
            </select>
        </div>
        
        <div id="score-display" class="score-display"></div>
        <div id="quiz-container"></div>
        
        <div class="btn-group">
            <button id="submit-btn" class="btn-submit" onclick="gradeTest()" style="display:none;">N·ªòP B√ÄI & XEM GI·∫¢I TH√çCH</button>
            <button id="retry-btn" class="btn-retry" onclick="loadTestFile()">L√ÄM L·∫†I ƒê·ªÄ</button>
        </div>

        <div class="history-section">
            <h3 style="color: var(--p-navy);">üìä L·ªãch S·ª≠ H·ªçc T·∫≠p C·ªßa B√©</h3>
            <table class="history-table">
                <thead>
                    <tr>
                        <th>Ng√†y/Gi·ªù</th>
                        <th>M√¥n H·ªçc</th>
                        <th>ƒê·ªÅ S·ªë</th>
                        <th>K·∫øt Qu·∫£</th>
                    </tr>
                </thead>
                <tbody id="history-body">
                    </tbody>
            </table>
            <button onclick="clearHistory()" style="margin-top: 10px; border: none; background: none; color: gray; cursor: pointer; text-decoration: underline;">X√≥a l·ªãch s·ª≠</button>
        </div>
    </div>
</div>

<script type="module">
    const SUBJECTS_CONFIG = {
        1: ["To√°n", "Ti·∫øng Vi·ªát"],
        2: ["To√°n", "Ti·∫øng Vi·ªát", "Ti·∫øng Anh", "To√°n Ti·∫øng Anh"],
        3: ["To√°n", "Ti·∫øng Vi·ªát", "Ti·∫øng Anh"],
        4: ["To√°n", "Ti·∫øng Vi·ªát", "Ti·∫øng Anh", "Khoa H·ªçc"],
        5: ["To√°n", "Ti·∫øng Vi·ªát", "Ti·∫øng Anh", "Khoa H·ªçc"]
    };

    let currentGrade = 2;
    let currentSubject = "To√°n";
    let questionsData = [];

    function cleanName(str) {
        return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "");
    }

    // T·∫£i l·ªãch s·ª≠ t·ª´ LocalStorage khi m·ªü trang
    window.onload = () => { displayHistory(); };

    window.changeGrade = (g) => {
        currentGrade = g;
        document.querySelectorAll('.tab-btn').forEach((b, i) => b.classList.toggle('active', (i+1) == g));
        renderSubjectTabs();
    };

    function renderSubjectTabs() {
        const container = document.getElementById('subject-tabs');
        container.innerHTML = '';
        const subs = SUBJECTS_CONFIG[currentGrade];
        subs.forEach((s, i) => {
            const btn = document.createElement('button');
            btn.className = `subject-btn ${s === currentSubject ? 'active' : ''}`;
            btn.innerText = s;
            btn.onclick = () => {
                currentSubject = s;
                document.querySelectorAll('.subject-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                loadTestFile();
            };
            container.appendChild(btn);
        });
        loadTestFile();
    }

    window.loadTestFile = async () => {
        const testNum = document.getElementById('test-select').value;
        const container = document.getElementById('quiz-container');
        const submitBtn = document.getElementById('submit-btn');
        const retryBtn = document.getElementById('retry-btn');
        const info = document.getElementById('current-info');
        
        container.innerHTML = "";
        submitBtn.style.display = "none";
        retryBtn.style.display = "none";
        document.getElementById('score-display').style.display = 'none';

        if (!testNum) return;
        info.innerText = `${currentSubject} L·ªõp ${currentGrade} - ƒê·ªÅ s·ªë ${testNum}`;

        const path = `./data/Lop${currentGrade}/${cleanName(currentSubject)}/de${testNum}.js`;

        try {
            const module = await import(path);
            questionsData = module.data;
            renderQuiz();
            submitBtn.style.display = "block";
        } catch (e) {
            container.innerHTML = `<p style="padding:20px;">‚ö†Ô∏è Ch∆∞a c√≥ d·ªØ li·ªáu cho <b>ƒê·ªÅ s·ªë ${testNum}</b> m√¥n ${currentSubject}.</p>`;
        }
    };

    function renderQuiz() {
        const container = document.getElementById('quiz-container');
        questionsData.forEach((q, i) => {
            const card = document.createElement('div');
            card.className = 'question-card';
            
            let inputArea = q.opts 
                ? `<div class="options-grid">${q.opts.map(o => `<label class="option-item"><input type="radio" name="q${i}" value="${o}"> ${o}</label>`).join('')}</div>`
                : `<select name="q${i}" style="margin-top:10px; padding:8px;"><option value="">-- Ch·ªçn s·ªë --</option>${Array.from({length: 21}, (_, n) => `<option value="${n}">${n}</option>`).join('')}</select>`;

            card.innerHTML = `
                <div><strong>C√¢u ${i+1}: ${q.q}</strong></div>
                ${q.img ? `<img src="${q.img}" class="q-img">` : ''}
                ${inputArea}
                <div id="ex${i}" class="explanation"></div>
            `;
            container.appendChild(card);
        });
    }

    window.gradeTest = () => {
        let score = 0;
        const submitBtn = document.getElementById('submit-btn');
        const retryBtn = document.getElementById('retry-btn');
        const testNum = document.getElementById('test-select').value;

        questionsData.forEach((q, i) => {
            const inputs = document.getElementsByName(`q${i}`);
            let ans = "";
            
            if (q.opts) {
                const checked = document.querySelector(`input[name="q${i}"]:checked`);
                ans = checked ? checked.value : "";
            } else {
                ans = document.querySelector(`select[name="q${i}"]`).value;
            }
            
            // Kh√≥a c√°c √¥ ch·ªçn sau khi n·ªôp b√†i
            inputs.forEach(input => {
                input.disabled = true;
                if(input.parentElement.classList.contains('option-item')) {
                    input.parentElement.classList.add('locked');
                }
            });
            if (!q.opts) document.querySelector(`select[name="q${i}"]`).disabled = true;

            const ex = document.getElementById(`ex${i}`);
            ex.style.display = 'block';
            if(ans == q.a) { 
                score++; 
                ex.innerHTML = `‚úÖ ƒê√∫ng! ${q.e}`; ex.style.color = 'green'; 
            } else { 
                ex.innerHTML = `‚ùå Sai. ƒê√°p √°n ƒë√∫ng: ${q.a}. ${q.e}`; ex.style.color = 'red'; 
            }
        });

        const sd = document.getElementById('score-display');
        sd.style.display = 'block';
        const finalResult = `${score}/${questionsData.length}`;
        sd.innerHTML = `K·∫øt qu·∫£: ${finalResult} c√¢u ƒë√∫ng!`;
        
        submitBtn.style.display = "none";
        retryBtn.style.display = "block";

        // L∆∞u v√†o l·ªãch s·ª≠
        saveHistory(currentSubject, testNum, finalResult);
        window.scrollTo({ top: 100, behavior: 'smooth' });
    };

    function saveHistory(subject, testNum, result) {
        let history = JSON.parse(localStorage.getItem('daubi_history') || '[]');
        const now = new Date();
        const dateTime = `${now.getDate()}/${now.getMonth() + 1} ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
        
        history.unshift({ dateTime, subject, testNum, result });
        localStorage.setItem('daubi_history', JSON.stringify(history.slice(0, 10))); // L∆∞u 10 k·∫øt qu·∫£ g·∫ßn nh·∫•t
        displayHistory();
    }

    function displayHistory() {
        const history = JSON.parse(localStorage.getItem('daubi_history') || '[]');
        const body = document.getElementById('history-body');
        body.innerHTML = history.map(item => `
            <tr>
                <td>${item.dateTime}</td>
                <td>${item.subject}</td>
                <td>${item.testNum}</td>
                <td style="font-weight:bold; color:var(--p-purple)">${item.result}</td>
            </tr>
        `).join('') || '<tr><td colspan="4">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o.</td></tr>';
    }

    window.clearHistory = () => {
        if(confirm("X√≥a to√†n b·ªô l·ªãch s·ª≠ h·ªçc t·∫≠p?")) {
            localStorage.removeItem('daubi_history');
            displayHistory();
        }
    };

    renderSubjectTabs();
</script>
</body>
</html>
